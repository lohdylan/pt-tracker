---
phase: 01-feature-verification
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - mobile/src/screens/clients/ProgressPhotosScreen.tsx
  - mobile/src/screens/clients/PhotoComparisonScreen.tsx
  - mobile/src/screens/portal/MyPhotosScreen.tsx
autonomous: false

must_haves:
  truths:
    - "Trainer can upload a progress photo from the device gallery with a category selection"
    - "Uploaded photo appears in the photo grid with correct category badge and date"
    - "Category filter chips work -- selecting a category filters the grid"
    - "Compare screen allows navigating between photos with before/after view"
    - "Trainer can long-press a photo to delete it"
    - "Client can view photos uploaded by trainer (view-only, no upload/delete)"
  artifacts:
    - path: "mobile/src/screens/clients/ProgressPhotosScreen.tsx"
      provides: "Trainer photo upload/view/delete UI"
      min_lines: 100
    - path: "mobile/src/screens/clients/PhotoComparisonScreen.tsx"
      provides: "Side-by-side photo comparison"
      min_lines: 30
    - path: "mobile/src/screens/portal/MyPhotosScreen.tsx"
      provides: "Client photo viewing UI"
      min_lines: 30
  key_links:
    - from: "mobile/src/screens/clients/ProgressPhotosScreen.tsx"
      to: "/api/clients/:clientId/progress-photos"
      via: "useProgressPhotos, useUploadProgressPhoto hooks"
      pattern: "useUploadProgressPhoto"
    - from: "mobile/src/screens/portal/MyPhotosScreen.tsx"
      to: "/api/clients/:clientId/progress-photos"
      via: "useProgressPhotos hook"
      pattern: "useProgressPhotos"
    - from: "ProgressPhotosScreen photo display"
      to: "server /uploads/progress/ static files"
      via: "UPLOADS_BASE + photo_url"
      pattern: "UPLOADS_BASE"
---

<objective>
Verify progress photo upload, viewing, filtering, comparison, and deletion work correctly on a physical iOS device. Fix the photo comparison edge case (1 photo) and any other bugs found during testing.

Purpose: Progress photos are a key trainer-client feature. The trainer uploads photos, both trainer and client can view/compare them. The code has been written but never tested on device -- photo uploads via FormData on iOS have known platform quirks.
Output: Any bug fixes in photo screens, and human verification that photos work end-to-end for both trainer and client.
</objective>

<execution_context>
@/Users/dylanwagner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dylanwagner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-feature-verification/01-RESEARCH.md
@.planning/phases/01-feature-verification/01-01-SUMMARY.md
@mobile/src/screens/clients/ProgressPhotosScreen.tsx
@mobile/src/screens/clients/PhotoComparisonScreen.tsx
@mobile/src/screens/portal/MyPhotosScreen.tsx
@mobile/src/hooks/useProgressPhotos.ts
@mobile/src/api.ts
@server/src/routes/progressPhotos.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix photo comparison edge case and review photo code</name>
  <files>mobile/src/screens/clients/PhotoComparisonScreen.tsx, mobile/src/screens/clients/ProgressPhotosScreen.tsx, mobile/src/screens/portal/MyPhotosScreen.tsx</files>
  <action>
1. Fix PhotoComparisonScreen edge case: When there is exactly 1 photo, the screen shows both "before" and "after" pointing to the same photo (rightIndex defaults to 0 when photos.length is 1). Fix this by:
   - If photos.length < 2, show a message like "Need at least 2 photos to compare" (the check for 0 photos exists on line 33 but does not cover the 1-photo case).
   - Update the condition to check `photos.length < 2` instead of just `!photos || photos.length === 0`.

2. Review the photo upload flow in ProgressPhotosScreen:
   - `handleUpload` uses `ImagePicker.launchImageLibraryAsync` with `mediaTypes: ["images"]` -- verify this is correct Expo Image Picker API for SDK 54.
   - The upload uses `api.uploadProgressPhoto(clientId, uri, category)` which sends FormData with the photo file, category field, and optional notes.
   - Verify the server route at `/api/clients/:clientId/progress-photos` accepts the FormData correctly (multer middleware).
   - Check that photo URLs returned by the server are correctly prefixed with `UPLOADS_BASE` when displayed.

3. Review MyPhotosScreen (client view):
   - Verify it fetches photos using the correct clientId from the auth context.
   - Verify it does NOT show upload or delete controls (client is view-only).

4. Verify the server serves uploaded files correctly:
   - Check that `server/src/index.ts` has `express.static` for the uploads directory.
   - Test: After a photo is uploaded, its URL should be accessible via `curl http://<IP>:3000/uploads/progress/<filename>`.

If any issues beyond the comparison edge case are found, fix them.
  </action>
  <verify>
- `cd mobile && npx tsc --noEmit 2>&1 | grep -i "Photo\|Comparison\|MyPhotos" || echo "No errors found"`
- PhotoComparisonScreen handles the 1-photo case gracefully
  </verify>
  <done>Photo comparison edge case fixed. All photo-related code reviewed and any issues corrected. Ready for device testing.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed photo comparison edge case (1 photo). Reviewed and (if needed) fixed photo upload, display, and client view code.</what-built>
  <how-to-verify>
Ensure server and Expo are running (from Plan 01 setup).

Test as trainer (password: test123):
1. Navigate to Clients tab > select a client > "Photos" tab > "View All Photos"
2. Tap the + FAB button to upload a photo
3. Select an image from the gallery
4. Choose a category (Front/Side/Back/Other) from the alert
5. Verify photo appears in the grid with the correct category badge and date
6. Upload at least 2 photos with different categories
7. Tap category filter chips (All/Front/Side/Back/Other) -- verify filtering works
8. Tap "Compare" button -- verify side-by-side comparison screen opens
9. Use left/right arrows to navigate between photos in comparison view
10. Long-press a photo in the grid -- verify delete confirmation appears
11. Delete a photo -- verify it's removed from the grid

Test as client (login with access code SAR101):
12. Navigate to Progress tab > "View Progress Photos"
13. Verify photos uploaded by trainer are visible
14. Verify category filter works
15. Verify there is NO upload button and NO delete option for clients

If any step fails, describe what happened.
  </how-to-verify>
  <resume-signal>Type "approved" if all steps pass, or describe any failures for Claude to fix.</resume-signal>
</task>

</tasks>

<verification>
- PhotoComparisonScreen shows "need at least 2 photos" for 0 or 1 photos
- TypeScript compiles without errors for photo-related files
- Human verified photo upload, display, filter, compare, and delete on device
- Human verified client view-only access on device
</verification>

<success_criteria>
Trainer can upload progress photos, view them in a timeline with category filtering, use the side-by-side comparison screen, and delete photos. Client can view photos uploaded by trainer but cannot upload or delete.
</success_criteria>

<output>
After completion, create `.planning/phases/01-feature-verification/01-02-SUMMARY.md`
</output>
