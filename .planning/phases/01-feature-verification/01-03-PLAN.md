---
phase: 01-feature-verification
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - mobile/src/screens/messages/ConversationListScreen.tsx
  - mobile/src/screens/messages/ChatScreen.tsx
  - mobile/src/screens/messages/ClientChatScreen.tsx
autonomous: false

must_haves:
  truths:
    - "Trainer sees a list of all active clients in the Messages tab"
    - "Trainer can tap a client to open chat, send a message, and see it appear right-aligned in blue"
    - "Client Messages tab goes directly to chat with trainer (no conversation list)"
    - "Client can send a message and see it appear right-aligned"
    - "Messages from the other role appear left-aligned within ~10 seconds (refetchInterval)"
    - "Unread badge on Messages tab updates when new messages arrive"
    - "Opening a chat clears the unread badge for that conversation"
    - "Conversation history persists after force-closing and reopening the app"
  artifacts:
    - path: "mobile/src/screens/messages/ConversationListScreen.tsx"
      provides: "Trainer conversation list"
      min_lines: 80
    - path: "mobile/src/screens/messages/ChatScreen.tsx"
      provides: "Trainer chat view"
      min_lines: 80
    - path: "mobile/src/screens/messages/ClientChatScreen.tsx"
      provides: "Client chat view"
      min_lines: 80
  key_links:
    - from: "mobile/src/screens/messages/ChatScreen.tsx"
      to: "/api/messages/conversations/:clientId"
      via: "useMessages, useSendMessage hooks"
      pattern: "useSendMessage"
    - from: "mobile/src/screens/messages/ClientChatScreen.tsx"
      to: "/api/messages/conversations/:clientId"
      via: "useMessages, useSendMessage, useMarkAsRead hooks"
      pattern: "useMarkAsRead"
    - from: "mobile/src/components/UnreadBadge.tsx"
      to: "/api/messages/unread-count"
      via: "useUnreadCount hook"
      pattern: "useUnreadCount"
---

<objective>
Fix known messaging bugs (ConversationListScreen client redirect, markAsRead useEffect dependency) and verify messaging works end-to-end between trainer and client on a physical iOS device.

Purpose: Messaging is the primary real-time communication channel between trainer and client. Two bugs were identified in code review that need fixing before device testing. The core messaging flow (send, receive, read receipts, unread badges) must work for both roles.
Output: Bug fixes in messaging screens, and human verification that messaging works bidirectionally on device.
</objective>

<execution_context>
@/Users/dylanwagner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dylanwagner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-feature-verification/01-RESEARCH.md
@.planning/phases/01-feature-verification/01-01-SUMMARY.md
@mobile/src/screens/messages/ConversationListScreen.tsx
@mobile/src/screens/messages/ChatScreen.tsx
@mobile/src/screens/messages/ClientChatScreen.tsx
@mobile/src/hooks/useMessages.ts
@mobile/src/components/UnreadBadge.tsx
@mobile/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ConversationListScreen client redirect and markAsRead dependency</name>
  <files>mobile/src/screens/messages/ConversationListScreen.tsx, mobile/src/screens/messages/ChatScreen.tsx, mobile/src/screens/messages/ClientChatScreen.tsx</files>
  <action>
Fix two known bugs identified in the research code review:

**Bug 1: ConversationListScreen client redirect (lines 41-45)**
The code calls `navigation.replace("ClientChat")` during render when user is a client, then returns null. This can cause a React Navigation warning about updating during render.

Although in practice the client Messages tab uses `ClientMessagesNavigator` which starts at `ClientChat` directly (so `ConversationListScreen` should never render for clients), this is still fragile code. Fix by:
- Wrap the redirect in a `useEffect` instead of doing it during render.
- Use `useLayoutEffect` for navigation to avoid flash:
```tsx
useLayoutEffect(() => {
  if (user?.role === "client") {
    navigation.replace("ClientChat");
  }
}, [user?.role, navigation]);

if (user?.role === "client") return null;
```

**Bug 2: markAsRead useEffect missing dependency in ChatScreen (line 33) and ClientChatScreen (line 30)**
Both screens have:
```tsx
useEffect(() => {
  markAsRead.mutate();
}, [messages?.length]);
```
The `markAsRead` is missing from the dependency array. This causes a React warning and potential stale closure.

Fix by extracting the mutate function reference to avoid the entire mutation object in deps:
```tsx
const markAsReadMutate = markAsRead.mutate;
useEffect(() => {
  markAsReadMutate();
}, [messages?.length, markAsReadMutate]);
```

Or alternatively, since `mutate` from React Query is stable:
```tsx
useEffect(() => {
  markAsRead.mutate();
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [messages?.length]);
```

Prefer the first approach (adding to deps) since React Query's `mutate` is referentially stable. Apply the same fix to BOTH ChatScreen.tsx and ClientChatScreen.tsx.

After fixes, do a quick review of the messaging hooks in `useMessages.ts`:
- Verify `useMessages(clientId)` polls with `refetchInterval` for near-real-time updates.
- Verify `useSendMessage` invalidates the messages query on success.
- Verify `useUnreadCount` is used in `UnreadBadge` component.
  </action>
  <verify>
- `cd mobile && npx tsc --noEmit 2>&1 | grep -i "Conversation\|ChatScreen\|ClientChat\|Message" || echo "No errors found"`
- ConversationListScreen no longer calls navigation during render
- ChatScreen and ClientChatScreen have correct useEffect dependencies
  </verify>
  <done>ConversationListScreen client redirect wrapped in useEffect. markAsRead dependency added in both ChatScreen and ClientChatScreen. All messaging code reviewed and ready for device testing.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed ConversationListScreen client redirect bug and markAsRead useEffect missing dependency in both chat screens. Reviewed messaging hooks for correctness.</what-built>
  <how-to-verify>
Ensure server and Expo are running.

Test as trainer (password: test123):
1. Navigate to Messages tab
2. Verify conversation list shows all active clients with names and avatars
3. Tap a client (e.g., Sarah) to open the chat
4. Type a message and tap Send
5. Verify the message appears right-aligned in blue with a timestamp
6. Send multiple messages -- verify they all appear and the list scrolls to the bottom
7. Go back to conversation list -- verify the last message preview is updated

Test as client (login with access code SAR101 -- use a different device or Expo session):
8. Navigate to Messages tab -- verify it goes directly to the chat (no conversation list)
9. Send a message to the trainer
10. Verify the message appears right-aligned
11. Switch to the trainer view -- verify the client's message appears left-aligned within ~10 seconds
12. As trainer, reply to the client
13. Switch to client view -- verify trainer's reply appears left-aligned within ~10 seconds
14. Check the Messages tab badge -- verify unread count appears when there are unread messages
15. Open the chat -- verify the unread badge clears
16. Force-close the app and reopen -- verify conversation history persists

Note: "~10 seconds" is the refetch interval. If messages appear instantly, even better. If they take longer than 30 seconds, that's a bug.

If any step fails, describe what happened.
  </how-to-verify>
  <resume-signal>Type "approved" if all steps pass, or describe any failures for Claude to fix.</resume-signal>
</task>

</tasks>

<verification>
- No React Navigation warnings during client redirect
- No React useEffect dependency warnings in chat screens
- TypeScript compiles without errors for messaging files
- Human verified bidirectional messaging on device
- Human verified unread badges and read receipts work
</verification>

<success_criteria>
Trainer and client can exchange messages in real time (within ~10 second polling interval). Unread badges update correctly. Opening chat clears unread. Conversation history persists across app restarts.
</success_criteria>

<output>
After completion, create `.planning/phases/01-feature-verification/01-03-SUMMARY.md`
</output>
