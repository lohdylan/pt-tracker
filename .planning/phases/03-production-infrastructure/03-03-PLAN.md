---
phase: 03-production-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - mobile/app.json
autonomous: false
user_setup:
  - service: railway
    why: "Server hosting, PostgreSQL, and S3-compatible storage bucket"
    env_vars:
      - name: JWT_SECRET
        source: "Generate a strong random string (e.g., openssl rand -hex 32) and paste into Railway Variables"
      - name: TRAINER_PASSWORD
        source: "Choose a production trainer password and paste into Railway Variables"
      - name: NODE_ENV
        source: "Set to 'production' in Railway Variables"
      - name: SENTRY_DSN
        source: "Sentry Dashboard -> Project -> Settings -> Client Keys (DSN)"
    dashboard_config:
      - task: "Create Railway project and add PostgreSQL service"
        location: "railway.com -> New Project -> Add PostgreSQL"
      - task: "Create Storage Bucket"
        location: "Railway project -> New -> Storage Bucket"
      - task: "Connect GitHub repo for auto-deploy"
        location: "Railway project -> New -> GitHub Repo -> select my-app"
      - task: "Set root directory to /server"
        location: "Railway service -> Settings -> Root Directory"
      - task: "Set environment variables"
        location: "Railway service -> Variables tab"
  - service: sentry
    why: "Error tracking and monitoring"
    env_vars:
      - name: SENTRY_DSN
        source: "Sentry Dashboard -> Project Settings -> Client Keys (DSN)"
    dashboard_config:
      - task: "Create Sentry account and Node.js project"
        location: "sentry.io -> Create Project -> Node.js -> Express"

must_haves:
  truths:
    - "Mobile app connects to the production API URL over HTTPS and can authenticate"
    - "Production database has all 12 migrations applied"
    - "File uploads in production go to S3 bucket and are viewable in the mobile app"
    - "Server errors in production are captured by Sentry"
    - "Environment variables are set via Railway, not hardcoded in code"
  artifacts:
    - path: "mobile/app.json"
      provides: "Production API URL in extra.apiUrl"
      contains: ".up.railway.app"
  key_links:
    - from: "mobile/app.json"
      to: "Railway server"
      via: "extra.apiUrl contains Railway HTTPS URL"
      pattern: "apiUrl"
    - from: "Railway Variables"
      to: "server/src/db.ts"
      via: "DATABASE_URL auto-injected by Railway PostgreSQL"
      pattern: "DATABASE_URL"
    - from: "Railway Variables"
      to: "server/src/instrument.ts"
      via: "SENTRY_DSN env var"
      pattern: "SENTRY_DSN"
---

<objective>
Deploy the server to Railway, provision the database and storage bucket, run migrations, set environment variables, and verify the full production stack works end-to-end.

Purpose: This is the final plan that puts everything online. Plans 01 and 02 prepared the code for production -- this plan gets it running on Railway with a real database, real S3 bucket, and real Sentry monitoring.

Output: A production server running at https://*.up.railway.app with PostgreSQL, S3 storage, Sentry monitoring, and the mobile app configured to connect to it.
</objective>

<execution_context>
@/Users/dylanwagner/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dylanwagner/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-production-infrastructure/03-RESEARCH.md
@.planning/phases/03-production-infrastructure/03-01-SUMMARY.md
@.planning/phases/03-production-infrastructure/03-02-SUMMARY.md
@mobile/app.json
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create Railway project with PostgreSQL, Storage Bucket, and Sentry project</name>
  <what-to-do>
Set up the production infrastructure on Railway and Sentry. Claude cannot create accounts or access dashboards on your behalf.

**Step 1: Create Sentry project**
1. Go to https://sentry.io and sign up (free Developer plan)
2. Create a new project: Platform = Node.js, Framework = Express
3. Copy the DSN string from Project Settings -> Client Keys (DSN). It looks like `https://xxx@oNNN.ingest.us.sentry.io/NNN`
4. Keep this DSN handy for Step 2

**Step 2: Create Railway project**
1. Go to https://railway.com and sign up (Hobby plan, $5/mo)
2. Click "New Project"
3. Add a PostgreSQL database: click "+ New" -> "Database" -> "PostgreSQL"
4. Add a Storage Bucket: click "+ New" -> "Storage Bucket"
   - Note the bucket credentials from the bucket's "Connect" tab (BUCKET_ENDPOINT, BUCKET_ACCESS_KEY_ID, BUCKET_SECRET_ACCESS_KEY, BUCKET_NAME, BUCKET_REGION)
5. Add the server service: click "+ New" -> "GitHub Repo" -> select the my-app repository
   - In the service Settings tab, set **Root Directory** to `server`
   - In the service Settings tab, set **Custom Start Command** to `node --import ./dist/instrument.mjs dist/index.js` (or leave blank if Railway auto-detects from package.json)

**Step 3: Set environment variables on the Railway server service**
Go to the server service -> Variables tab and add:
- `NODE_ENV` = `production`
- `JWT_SECRET` = (generate with `openssl rand -hex 32` in terminal, paste the result)
- `TRAINER_PASSWORD` = (choose a strong password for the trainer login)
- `SENTRY_DSN` = (paste the DSN from Step 1)
- `DATABASE_URL` = (use Railway's reference: `${{Postgres.DATABASE_URL}}`)
- `BUCKET_ENDPOINT` = (from bucket Connect tab)
- `BUCKET_ACCESS_KEY_ID` = (from bucket Connect tab)
- `BUCKET_SECRET_ACCESS_KEY` = (from bucket Connect tab)
- `BUCKET_NAME` = (from bucket Connect tab)
- `BUCKET_REGION` = (from bucket Connect tab, likely `us-east-1`)

**Step 4: Run migrations**
In Railway, go to the server service -> Settings -> add a deploy command, or use the Railway CLI:
```bash
# Option A: Railway CLI
railway run npx tsx src/migrate.ts

# Option B: In the Railway dashboard, open the service shell and run:
npx tsx src/migrate.ts
```

**Step 5: Deploy**
Push to the connected branch (usually `main`) or trigger a manual deploy in the Railway dashboard. Wait for the build to complete.

**Step 6: Get the production URL**
Go to the server service -> Settings -> Networking -> Generate Domain. Copy the URL (e.g., `https://pt-tracker-production.up.railway.app`).

**When ready, respond with:**
- The production URL (e.g., `https://pt-tracker-production.up.railway.app`)
- Confirmation that migrations ran successfully
- Confirmation that the deploy completed without errors
  </what-to-do>
  <resume-signal>Provide the Railway production URL and confirm deploy + migrations succeeded</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Set production API URL in mobile app and verify end-to-end</name>
  <files>mobile/app.json</files>
  <action>
Using the Railway production URL provided by the user in Task 1:

1. Update mobile/app.json to set the production API URL in the extra field:
   ```json
   {
     "expo": {
       ...existing fields...,
       "extra": {
         "apiUrl": "https://RAILWAY_URL_FROM_TASK_1"
       }
     }
   }
   ```
   Replace `RAILWAY_URL_FROM_TASK_1` with the actual URL (no trailing slash).

2. Verify the production server is responding:
   ```bash
   curl https://RAILWAY_URL/api/health
   ```
   Expected: `{"status":"ok","timestamp":"..."}`

3. Verify authentication works:
   ```bash
   curl -X POST https://RAILWAY_URL/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"password":"TRAINER_PASSWORD_FROM_TASK_1"}'
   ```
   Expected: `{"token":"...","role":"trainer"}`
   Note: The trainer password was set in Railway Variables. Ask the user for it if needed, or use the health check as primary verification.

4. Verify database has migrations:
   ```bash
   # Using the trainer token from step 3
   curl https://RAILWAY_URL/api/clients \
     -H "Authorization: Bearer TOKEN"
   ```
   Expected: empty array `[]` (no seed data yet, but should not error)

5. Verify Sentry is receiving events (optional):
   ```bash
   # Trigger a test error -- hit a non-existent route
   curl https://RAILWAY_URL/api/nonexistent
   ```
   Check Sentry dashboard for the captured error event.

6. Run the seed script against production (if the user wants initial data):
   Ask the user: "Do you want to seed the production database with sample data? This will create 8 test clients, sample sessions, and exercises. Reply 'seed' to run it, or 'skip' to start with an empty database."

   If seed: The user must run this via Railway CLI since it needs DATABASE_URL:
   ```bash
   railway run npx tsx src/seed.ts
   ```
  </action>
  <verify>
1. `curl https://RAILWAY_URL/api/health` returns 200 with status "ok"
2. `curl -X POST https://RAILWAY_URL/api/auth/login` with correct password returns a JWT token
3. `curl https://RAILWAY_URL/api/clients` with Bearer token returns 200 (empty array or seeded data)
4. mobile/app.json has the correct Railway URL in extra.apiUrl
  </verify>
  <done>Production API responds over HTTPS, authentication works, database is migrated, mobile app.json points to production URL, Sentry configured for error capture</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify mobile app connects to production</name>
  <what-built>
The complete production infrastructure: Railway server with PostgreSQL, S3 storage bucket, Sentry error monitoring, and the mobile app configured to point at the production API URL.
  </what-built>
  <how-to-verify>
1. Start the mobile app: `cd mobile && npx expo start`
2. Open the app on your iOS device
3. Log in as trainer (use the production TRAINER_PASSWORD you set in Railway)
4. Verify the dashboard loads with data (or empty state if not seeded)
5. Try creating a client -- it should persist
6. Try uploading a client photo -- it should upload to S3 and display in the app
7. Log in as a client using an access code (if seeded: SAR101, MAR102, etc.)
8. Check that the client sees their sessions and data

If anything fails, describe what you see and the error message.
  </how-to-verify>
  <resume-signal>Type "approved" if everything works, or describe issues you encountered</resume-signal>
</task>

</tasks>

<verification>
1. Production health endpoint returns 200 over HTTPS
2. Trainer can authenticate with production password
3. Database has all 12 migrations applied (API routes work, not schema errors)
4. File uploads go to S3 bucket (not local disk)
5. Sentry project shows captured events (at minimum the test error)
6. Mobile app connects to production API and performs CRUD operations
7. Environment variables are in Railway Variables, not hardcoded
</verification>

<success_criteria>
- The mobile app can connect to the production API URL over HTTPS and perform all operations (auth, CRUD, file uploads) -- Success Criterion #1
- Production database has all 12 migrations applied -- Success Criterion #2
- Environment variables (JWT_SECRET, database URL) are set via Railway's secret management -- Success Criterion #3
- Server errors are captured by Sentry and the trainer can be alerted when something breaks -- Success Criterion #4
</success_criteria>

<output>
After completion, create `.planning/phases/03-production-infrastructure/03-03-SUMMARY.md`
</output>
